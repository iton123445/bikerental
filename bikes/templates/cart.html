{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container">
  <h2>Cart</h2>

  {% if bikes %}
  <div class="row">
    {% for bike in bikes %}
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ bike.name }}</h5>
          <p class="card-text">Quantity: {{ cart|get_item:bike.id }}</p>
          <p class="card-text">Price: ${{ bike.price }}</p>
          <input type="hidden" name="bike_id" value="{{ bike.price }}" id="bike_id">
          <a href="{% url 'remove_from_cart' bike.id %}" class="btn btn-danger">Remove from Cart</a>
          <form method="post" action="{% url 'confirm_booking' %}" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="bike_id" value="{{ bike.id }}">
            <div class="form-group">
              <label for="start_date">Start Date:</label>
              <input type="text" id="start_date" name="start_date" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="end_date">End Date:</label>
              <input type="text" id="end_date" name="end_date" class="form-control" required>
              <div class="invalid-feedback" id="date-error" style="display: none;">Start date and end date cannot be the same.</div>
            </div>
            <div class="form-group">
              <label for="borrowed_days">Borrowed Days:</label>
              <input type="text" id="borrowed_days" name="borrowed_days" class="form-control" readonly>
            </div>
            <div class="form-group">
              <label for="total_price">Total Price:</label>
              <input type="text" id="total_price" name="total_price" class="form-control" readonly>
            </div><br>
            <button type="submit" class="btn btn-primary">Proceed to Book</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info mt-4" role="alert">
    Your cart is empty.
  </div>
  {% endif %}
</div>

<script>
  $(document).ready(function () {
    var endDateField = $('#end_date');
    var pricePerDay = parseFloat($('#bike_id').val()); 

    // Initialize Datepicker for start_date field
    $('#start_date').datepicker({
      format: 'yyyy-mm-dd', // Date format
      autoclose: true, // Close the datepicker when a date is selected
      todayHighlight: true, // Highlight today's date
      startDate: new Date(), // Disable dates before today
    }).on('changeDate', function (e) {
      // Calculate the number of borrowed days when the start date changes
      calculateBorrowedDays();

      // Enable end date field and set minimum date
      endDateField.prop('disabled', false);
      endDateField.datepicker('setStartDate', e.date);
    });

    // Initialize Datepicker for end_date field
    endDateField.datepicker({
      format: 'yyyy-mm-dd', // Date format
      autoclose: true, // Close the datepicker when a date is selected
      todayHighlight: true, // Highlight today's date
      startDate: new Date(), // Disable dates before today
    }).on('changeDate', function (e) {
      // Calculate the number of borrowed days when the end date changes
      calculateBorrowedDays();

      // Display error message if start date and end date are the same
      var startDate = $('#start_date').datepicker('getDate');
      if (startDate && e.date.getTime() === startDate.getTime()) {
        $('#date-error').show();
      } else {
        $('#date-error').hide();
      }
    });

    function calculateBorrowedDays() {
      var startDate = $('#start_date').datepicker('getDate');
      var endDate = endDateField.datepicker('getDate');

      if (startDate && endDate) {
        var diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        $('#borrowed_days').val(diff);
        var totalPrice = diff * pricePerDay;
        $('#total_price').val('$' + totalPrice.toFixed(2));
      }
    }
  });
</script>
{% endblock %}
